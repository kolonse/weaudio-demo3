<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>audio demo</title>
    <style type="text/css">
      button {
        background-color: green;
        width:50%;
        height:50px;
        font-size:30px;
      }
    </style>
  </head>
  <body>
    <p><strong>Run Status</strong></p>
    <textarea id="log" disabled></textarea>
    <br>
    <p><strong>select conditions:</strong> </p>
    <div class="conditions" id="conditions">
        <input type="radio" name="network" id="useUDP" value="useUDP" checked>
        <label for="useUDP">Use UDP</label>
        <br>
        <input type="radio" name="network" id="useWebsocket" value="useWebsocket">
        <label for="useWebsocket">Use Websocket</label>
        <br>
        <br>
        <input type="checkbox" name="useAPM" id="useAPM" value="useAPM" checked>
        <label for="useAPM">Enable Audio Process(AEC/AGC/NS)</label> 
        <br>

        <input type="checkbox" name="usePeer" id="usePeer" value="usePeer" checked>
        <label for="usePeer">Enable PeerConnection</label> 
        <br>
    </div>
    <br>
    <p><strong>select mic devices list:</strong> </p>
    <div class="inputs" id="inputs">
    </div>
    <br>
    <p><strong>select speaker devices list:</strong></p>
    <div class="outputs" id="outputs">
    </div>

    <br>
    <button onclick="StartText(this)" disabled id="startText"><strong>Start Test</strong></button>
    <script src="wusocket.js"></script>
    <script src="udpsocket.js"></script>
    <script src="sab.js"></script>
    <script src="audioapi.js"></script>
    <script src="audiotest.js"></script>
    <script>        
        class wokletNode extends AudioWorkletNode {
            constructor(context) {
                super(context, 'myworklet');
                this.port.onmessage = this.handleMessage.bind(this);
            }

            handleMessage(event) {
            }
        }

        class Workers {
            constructor() {
                this.workers = {};
            }

            start(name, path, cb) {
                if (this.workers[name]) return ;
                let worker = new Worker(path);
                this.workers[name] = worker;
                let that = this;
                worker.onmessage = cb || function() {
                    that.onmessage.call(that, name, ...arguments)
                }
            }

            postMessage(name, ...args) {
                let worker = this.workers[name];
                if (!worker) return ;

                worker.postMessage.apply(worker, args);
            }

            onmessage(name, ...args) {

            }
        }
        let sharedBuffer = {
            inputState: new SharedArrayBuffer(5 * 4),
            inputBuffer: new SharedArrayBuffer(640 * 4 * 4),

            outputState: new SharedArrayBuffer(5 * 4),
            outputBuffer: new SharedArrayBuffer(640 * 4 * 4),
        }

        let sendSharedBuffer = {
            state : new SharedArrayBuffer(5 * 4),
            buffer : new SharedArrayBuffer(600 * 4 * 4)
        }

        let receiveSharedBuffer = {
            state : new SharedArrayBuffer(5 * 4),
            buffer : new SharedArrayBuffer(600 * 4 * 4)
        }

        let workers = new Workers();
        workers.start("encode", "./encode.js", (e) => {
            if (e.data.event === 0) {
                WorkerOK(true, true);
            }
        });
        workers.start("decode", "./decode.js", (e) => {
            if (e.data.event === 0) {
                WorkerOK(false, true);
            }
        });

        workers.postMessage("encode", {
            event : "sharedBuffer",
            sharedBuffer : sharedBuffer,
            sendSharedBuffer : sendSharedBuffer
        });

        workers.postMessage("decode", {
            event : "sharedBuffer",
            sharedBuffer : sharedBuffer,
            receiveSharedBuffer : receiveSharedBuffer
        });

        let encodeOK, decodeOK;
        let startTextButton = document.getElementById("startText");
        function WorkerOK(encode, state) {
            if (encode) encodeOK = state;
            else decodeOK = state;

            if (encodeOK && decodeOK) {
                startTextButton.disabled = false;
                log("all is ok!!!");
            }
        }

        let audioText = null;
        function StartText() {
            if (audioText) audioText.stop();

            let inputs = inputsDom.querySelectorAll("input");
            let outputs = outputsDom.querySelectorAll("input");
            let conditions = conditionDom.querySelectorAll("input");

            let inputDeviceId, outputDeviceId ;
            let useUDP, useWebsocket;
            let useAPM, usePeer;
            console.log(inputs,outputs);

            conditions.forEach(input => {
                if (input.id === "useUDP") {
                    useUDP = input.checked;
                }

                if (input.id === "useWebsocket") {
                    useWebsocket = input.checked;
                }

                if (input.id === "useAPM" ) {
                    useAPM = input.checked;
                }

                if (input.id === "usePeer") {
                    usePeer = input.checked;
                }
            });

            inputs.forEach(input => {
                if (input.checked) {
                    inputDeviceId = input.id;
                }
            });

            outputs.forEach(input => {
                if (input.checked) {
                    outputDeviceId = input.id;
                }
            })
            console.log(inputDeviceId, outputDeviceId, useUDP);
            audioText = new AudioTest(inputDeviceId, outputDeviceId, {
                useUDP : useUDP,
                useWebsocket : useWebsocket,
                useAPM : useAPM,
                usePeer : usePeer
            });
            audioText.start();
        }
    </script>
  </body>
</html>


