<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>audio demo</title>
    <style type="text/css">
      button {
        background-color: green;
        width:50%;
        height:50px;
        font-size:30px;
      }

      textarea {
          width:30%;
      }
    </style>
  </head>
  <body>
    <p><strong>Run Status</strong></p>
    <textarea id="log" disabled></textarea>
    <br>
    <p><strong>select conditions:</strong> </p>
    <div class="conditions" id="conditions">
        <input type="radio" name="network" id="useUDP" value="useUDP" checked>
        <label for="useUDP">Use UDP</label>
        <br>
        <input type="radio" name="network" id="useWebsocket" value="useWebsocket">
        <label for="useWebsocket">Use Websocket</label>
        <br>
    </div>
    <br>
    <button onclick="StartText(this)"><strong>Start Test</strong></button>
    <script src="wusocket.js"></script>
    <script>
        let logDom = document.getElementById("log");
        let conditionDom = document.getElementById("conditions");
        let network = null;
        let check_timer_interval = null;
        let sendSeq = 0;
        let maxStableCount = 200;
        let timeNow = null;
        let buff = new Uint8Array(100);

        function log(str) {
            logDom.textContent = str;
        }

        function Send_timer() {
            network.send(buff.buffer);
            sendSeq ++;
        }

        function Check_timer() {
            network.send("check ==>" + sendSeq );
            sendSeq ++;
            if (sendSeq > maxStableCount) {
                clearInterval(check_timer_interval);
                setInterval( Send_timer, 20);
                log("udp is working!!!!");
            }
        }

        function Recv_Pck(evt) {
            timeNow = new Date().getTime();
        }

        function StartText() {
            let conditions = conditionDom.querySelectorAll("input");
            let useUDP = false;
            let useWebsocket = false;
            
            conditions.forEach(input => {
                if (input.id === "useUDP") {
                    useUDP = input.checked;
                }
                
                if (input.id === "useWebsocket") {
                    useWebsocket = input.checked;
                }
            });

            if (useUDP) {
                testUDP ();
            } else {
                testWebsock ();
            }

            timeNow = new Date().getTime();
            setInterval(() =>{ 
                let cap = new Date().getTime() - timeNow;
                if (cap > 5000) {
                    log("network maybe is bad, long time can't receive message");
                }
            }, 500)
        }

        function testUDP() {
            let url = window.location.origin + "/udp";
            network = new WuSocket(url);
            check_timer_interval = null;
            sendSeq = 0;
            maxStableCount = 200;

            network.onopen = ()=>{
                log("udp is testing, wait a moment!!!!");
                check_timer_interval = setInterval( Check_timer, 100);
            }
            network.onmessage = Recv_Pck;
        }

        function testWebsock() {
            sendSeq = 0;
            let proto = window.location.protocol.indexOf("https") === -1 ? "ws://" : "wss://"
            let url = proto + window.location.host + "/websocket";
            // let url = "ws://127.0.0.1:9553/";
            network = new WebSocket(url);
            network.onopen = () =>{
                log("websocket running");
                setInterval( Send_timer, 20);
            }
            network.onclose = () =>{
                log("websocket closed");
            }

            network.onerror = (err) =>{
                console.error(err);
            }
            network.onmessage = Recv_Pck;
        }
    </script>
  </body>
</html>


