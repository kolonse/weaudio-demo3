<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>audio demo</title>
    <style type="text/css">
      button {
        background-color: green;
        width:50%;
        height:50px;
        font-size:30px;
      }
    </style>
  </head>
  <body>
    <p><strong>Run Status</strong></p>
    <textarea id="log" disabled></textarea>
    <br>
    <p><strong>select conditions:</strong> </p>
    <div class="conditions" id="conditions">
        <input type="checkbox" name="useUDP" id="useUDP" value="useUDP" checked>
        <label for="useUDP">Use UDP</label>
        <br>
    </div>
    <br>
    <p><strong>select mic devices list:</strong> </p>
    <div class="inputs" id="inputs">
    </div>
    <br>
    <p><strong>select speaker devices list:</strong></p>
    <div class="outputs" id="outputs">
    </div>

    <br>
    <button onclick="StartText(this)"><strong>Start Test</strong></button>
    <script src="wusocket.js"></script>
    <script src="udpsocket.js"></script>
    <script src="sab.js"></script>
    <script src="audioapi.js"></script>
    <script src="audiotest.js"></script>
    <script>        
        class wokletNode extends AudioWorkletNode {
            constructor(context) {
                super(context, 'myworklet');
                this.port.onmessage = this.handleMessage.bind(this);
            }

            handleMessage(event) {
            }
        }

        class Workers {
            constructor() {
                this.workers = {};
            }

            start(name, path, cb) {
                if (this.workers[name]) return ;
                let worker = new Worker(path);
                this.workers[name] = worker;
                let that = this;
                worker.onmessage = cb || function() {
                    that.onmessage.call(that, name, ...arguments)
                }
            }

            postMessage(name, ...args) {
                let worker = this.workers[name];
                if (!worker) return ;

                worker.postMessage.apply(worker, args);
            }

            onmessage(name, ...args) {

            }
        }
        let sharedBuffer = {
            inputState: new SharedArrayBuffer(5 * 4),
            inputBuffer: new SharedArrayBuffer(640 * 4 * 4),

            outputState: new SharedArrayBuffer(5 * 4),
            outputBuffer: new SharedArrayBuffer(640 * 4 * 4),
        }

        let sendSharedBuffer = {
            state : new SharedArrayBuffer(5 * 4),
            buffer : new SharedArrayBuffer(600 * 4 * 4)
        }

        let receiveSharedBuffer = {
            state : new SharedArrayBuffer(5 * 4),
            buffer : new SharedArrayBuffer(600 * 4 * 4)
        }

        let workers = new Workers();
        workers.start("encode", "./encode.js");
        workers.start("decode", "./decode.js");

        workers.postMessage("encode", {
            event : "sharedBuffer",
            sharedBuffer : sharedBuffer,
            sendSharedBuffer : sendSharedBuffer
        });

        workers.postMessage("decode", {
            event : "sharedBuffer",
            sharedBuffer : sharedBuffer,
            receiveSharedBuffer : receiveSharedBuffer
        });


        let audioText = null;
        function StartText() {
            if (audioText) audioText.stop();

            let inputs = inputsDom.querySelectorAll("input");
            let outputs = outputsDom.querySelectorAll("input");
            let conditions = conditionDom.querySelectorAll("input");

            let inputDeviceId, outputDeviceId ;
            let useUDP ;
            console.log(inputs,outputs);

            conditions.forEach(input => {
                if (input.checked) {
                    useUDP = input.checked;
                }
            });

            inputs.forEach(input => {
                if (input.checked) {
                    inputDeviceId = input.id;
                }
            });

            outputs.forEach(input => {
                if (input.checked) {
                    outputDeviceId = input.id;
                }
            })

            console.log(inputDeviceId, outputDeviceId, useUDP);
            audioText = new AudioTest(inputDeviceId, outputDeviceId, {
                useUDP : useUDP
            });
            audioText.start();
        }
    </script>
  </body>
</html>


