<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>audio demo</title>
    <style type="text/css">
      button {
        background-color: green;
        width:50%;
        height:50px;
        font-size:30px;
      }

      textarea {
          width:500px;
          height:100px;
      }
    </style>
  </head>
  <body>
    <p><strong>Run Status</strong></p>
    <textarea id="log" disabled></textarea>
    <br>
    <p><strong>select conditions:</strong> </p>
    <div class="conditions" id="conditions">
        <label for="rtpFile">Choose a rtp file:</label>
        <input type="file" id="rtpFile" name="rtpFile" accept=".pkt">
    </div>
    <br>
    <p><strong>select speaker devices list:</strong></p>
    <div class="outputs" id="outputs">
    </div>
    <br>
    <button disabled onclick="StartText(this)" id="startText">Start Test</button>

    <script src="audioapi.js"></script>
    <script src="common.js"></script>
    <script src="player.js"></script>
    <script src="sab.js"></script>
    <script>
        let rtpFileDom = document.getElementById("rtpFile");
        let startButton = document.getElementById("startText");

        let audioTest;
        let workers = new Workers();
        log("start worker ...");

        workers.start("decode", "./decode.js", (e) => {
            if (e.data.event === 0) {
                // WorkerOK(false, true);
                log("worker start ok ...");
                startButton.disabled = false;
            }
        });

        workers.postMessage("decode", {
                event : "sharedBuffer",
                sharedBuffer : sharedBuffer,
                receiveSharedBuffer : receiveSharedBuffer
        });

        let isStartTest = true;
        function StartText() {
            if (!isStartTest) {
                workers.postMessage("decode", {
                    event : "stop"
                });
                audioTest.stop();
                audioTest = null;
                isStartTest = true ;
                startButton.textContent = "Start Test";
                log("Test Stop...")
                return ;
            }
            let rtpFiles = rtpFileDom.files;
            if (rtpFiles.length === 0) {
                log("you don't select file ...");
                return ;
            }
            let rtpFile = rtpFiles.item(0);
            console.log(rtpFile)
            log("you select file ---> " + rtpFile.name);

            let outputDeviceId;
            let outputs = outputsDom.querySelectorAll("input");
            outputs.forEach(input => {
                if (input.checked) {
                    outputDeviceId = input.id;
                }
            })
            if (audioTest) {
                audioTest.stop();
                audioTest = null;
            }

            audioTest = new AudioTest(outputDeviceId, rtpFile);
            audioTest.onplaystart = function() {
                log("audio playing ...");
                workers.postMessage("decode", {
                    event : "start"
                });
                startButton.textContent = "Stop Test";
            }
            audioTest.onplayend = function() {
                workers.postMessage("decode", {
                    event : "stop"
                });
                audioTest.stop();
                audioTest = null;
                isStartTest = true;
                startButton.textContent = "Start Test";
                log("audio play complete.")
            }
            audioTest.start();
            isStartTest = false;
        }

    </script>
  </body>
</html>


